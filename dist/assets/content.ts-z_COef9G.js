(function(){var x=Object.defineProperty;var A=(o,t,n)=>t in o?x(o,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[t]=n;var l=(o,t,n)=>A(o,typeof t!="symbol"?t+"":t,n);class b{static generate(t){if(!t)return"";if(t.id&&this.isSafeId(t.id))return`#${t.id}`;const n=this.getClassPath(t);return n&&this.isUnique(n)?n:this.getStructuralPath(t)}static getStructuralPath(t){const n=[];let e=t;for(;e&&e.tagName!=="BODY"&&e.tagName!=="HTML";){let i=e.tagName.toLowerCase();const r=e.parentElement;if(r){const s=Array.from(r.children).filter(a=>a.tagName===(e==null?void 0:e.tagName));if(s.length>1){const a=s.indexOf(e)+1;i+=`:nth-of-type(${a})`}}n.unshift(i),e=e.parentElement}return n.join(" > ")}static getClassPath(t){const n=this.getSafeClass(t);if(!n)return null;const e=`${t.tagName.toLowerCase()}.${n}`;if(this.isUnique(e))return e;const i=t.parentElement;if(i){const r=this.getSafeClass(i);if(r)return`${`${i.tagName.toLowerCase()}.${r}`} > ${e}`}return null}static getSafeClass(t){if(!t.className||typeof t.className!="string")return null;const n=t.className.split(" ").filter(e=>!(e.includes(":")||e.length<3||/^[0-9]/.test(e)));return n.length===0?null:n[0]}static isSafeId(t){return!/[0-9]{3,}/.test(t)}static isUnique(t){try{return document.querySelectorAll(t).length===1}catch{return!1}}}class P{constructor(){l(this,"overlayContainer");l(this,"overlays",[]);this.overlayContainer=document.createElement("div"),this.overlayContainer.id="ultimate-scraper-highlight-container",Object.assign(this.overlayContainer.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"0",zIndex:"2147483647",pointerEvents:"none"}),document.body.appendChild(this.overlayContainer)}highlight(t,n=!1){this.clear(),this.addOverlay(t,n)}highlightGroup(t){this.clear(),t.forEach(n=>this.addOverlay(n,!0))}addOverlay(t,n){if(!t)return;const e=t.getBoundingClientRect(),i=window.scrollY||document.documentElement.scrollTop,r=window.scrollX||document.documentElement.scrollLeft,s=document.createElement("div");if(Object.assign(s.style,{position:"absolute",background:n?"rgba(59, 130, 246, 0.1)":"rgba(59, 130, 246, 0.2)",border:n?"1px dashed #3b82f6":"2px solid #3b82f6",pointerEvents:"none",transition:"all 0.1s ease",borderRadius:"4px",boxSizing:"border-box",top:`${e.top+i}px`,left:`${e.left+r}px`,width:`${e.width}px`,height:`${e.height}px`}),!n){const a=document.createElement("div");Object.assign(a.style,{position:"absolute",background:"#3b82f6",color:"white",padding:"2px 6px",fontSize:"12px",fontFamily:"sans-serif",borderRadius:"4px",top:"-24px",left:"0",whiteSpace:"nowrap"});const c=t.tagName.toLowerCase(),f=t.className&&typeof t.className=="string"?`.${t.className.split(" ")[0]}`:"";a.textContent=`${c}${f}`,s.appendChild(a)}this.overlayContainer.appendChild(s),this.overlays.push(s)}clear(){this.overlays.forEach(t=>t.remove()),this.overlays=[]}destroy(){this.overlayContainer.remove()}}class L{static findSimilar(t,n){if(!t||!n)return[];let e=[];const i=n.replace(/:nth-child\(\d+\)/g,"").replace(/:nth-of-type\(\d+\)/g,"");if(i!==n)try{const r=document.querySelectorAll(i);e=Array.from(r)}catch{console.warn("Invalid relaxed selector:",i)}return e.length<=1&&(e=this.findSiblingsByStructure(t)),e.filter(r=>!(r.offsetParent===null||r.tagName!==t.tagName||t.className&&r.className!==t.className))}static findSiblingsByStructure(t){if(!t.parentElement)return[t];let e=t.parentElement,i=0;const r=5;for(;e&&i<r;){const s=e.parentElement;if(!s)break;const a=Array.from(s.children).filter(c=>c.tagName===(e==null?void 0:e.tagName));if(a.length>2)return this.projectDown(a,t,i+1);e=s,i++}return[t]}static projectDown(t,n,e){const i=[];let r=n;for(let a=0;a<e;a++){if(!r||!r.parentElement)return[];const c=r.parentElement,f=Array.from(c.children).indexOf(r);i.unshift(f),r=c}const s=[];return t.forEach(a=>{let c=a,f=!0;for(const S of i)if(c.children[S])c=c.children[S];else{f=!1;break}f&&s.push(c)}),s}}const g=o=>{if(typeof chrome<"u"&&chrome.runtime)try{chrome.runtime.sendMessage(o)}catch(t){console.warn("Failed to send message (Extension context missing?):",t)}else console.log("[Dev] Message sent:",o)};class I{constructor(){l(this,"intervalId",null);l(this,"isScrollActive",!1);l(this,"seenItems",new Set);l(this,"rootSelector","");l(this,"totalCollected",0)}start(t,n){this.isScrollActive||(this.isScrollActive=!0,this.rootSelector=n,this.seenItems.clear(),this.totalCollected=0,console.log("AutoScroller: Started"),this.scrapeVisible(),this.intervalId=setInterval(()=>{if(!this.isScrollActive){this.stop();return}window.scrollBy({top:500,behavior:"smooth"}),this.scrapeVisible(),window.innerHeight+window.scrollY>=document.body.offsetHeight-100&&console.log("AutoScroller: Bottom reached")},1500))}stop(){this.isScrollActive=!1,this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),console.log("AutoScroller: Stopped"),g({action:"SCROLL_STOPPED",payload:{total:this.totalCollected}})}scrapeVisible(){const t=this.rootSelector.replace(/:nth-child\(\d+\)/g,"").replace(/:nth-of-type\(\d+\)/g,""),n=document.querySelectorAll(t);if(n.length===0)return;const e=[];n.forEach(i=>{var a;const r=i,s=`${r.tagName}-${r.className}-${(a=r.innerText)==null?void 0:a.substring(0,20)}`;this.seenItems.has(s)||(this.seenItems.add(s),e.push({tagName:r.tagName,className:r.className,innerText:r.innerText}),this.totalCollected++)}),e.length>0&&(console.log(`AutoScroller: Found ${e.length} new items`),g({action:"DATA_SCRAPED",payload:{items:e,total:this.totalCollected}}))}}class O{constructor(){l(this,"isRunning",!1);l(this,"nextButtonSelector","");l(this,"itemSelector","");l(this,"totalCollected",0)}setSelectors(t,n){this.nextButtonSelector=t,this.itemSelector=n}async start(){if(!this.isRunning)for(this.isRunning=!0,this.totalCollected=0,console.log("PaginationManager: Started");this.isRunning;){this.scrapeCurrentPage();const t=document.querySelector(this.nextButtonSelector);if(t)console.log("PaginationManager: Clicking Next"),t.click(),await this.wait(3e3);else{console.log("PaginationManager: Next button not found. Stopping."),this.stop();break}}}stop(){this.isRunning=!1,console.log("PaginationManager: Stopped"),g({action:"PAGINATION_STOPPED",payload:{total:this.totalCollected}})}scrapeCurrentPage(){const t=this.itemSelector.replace(/:nth-child\(\d+\)/g,"").replace(/:nth-of-type\(\d+\)/g,""),n=document.querySelectorAll(t),e=[];n.forEach(i=>{const r=i;e.push({tagName:r.tagName,className:r.className,innerText:r.innerText})}),e.length>0&&(this.totalCollected+=e.length,g({action:"DATA_SCRAPED",payload:{items:e,total:this.totalCollected}}))}wait(t){return new Promise(n=>setTimeout(n,t))}}console.log("Ultimate Scraper Content Script Loaded");let d=null,y=new I,p=new O,h=!1,m="data",u=null;chrome.runtime.onMessage.addListener((o,t,n)=>{if(o.action==="PING"&&console.log("Content Script Pinged"),o.action==="START_SELECTION"&&(m="data",E()),o.action==="STOP_SELECTION"&&N(),o.action==="START_AUTO_SCROLL"){const{selector:e}=o.payload||{};e&&y.start(document.body,e)}if(o.action==="STOP_AUTO_SCROLL"&&y.stop(),o.action==="START_PAGINATION_SELECTION"&&(m="pagination",E()),o.action==="START_PAGINATION"){const{nextBtnSelector:e,itemSelector:i}=o.payload||{};e&&i&&(p.setSelectors(e,i),p.start())}o.action==="STOP_PAGINATION"&&p.stop()});function E(){h||(h=!0,document.body.style.cursor="crosshair",d=new P,document.addEventListener("mouseover",v),document.addEventListener("mouseout",C),document.addEventListener("click",T),document.addEventListener("keydown",w))}function N(){h=!1,document.body.style.cursor="default",d&&(d.clear(),d=null),document.removeEventListener("mouseover",v),document.removeEventListener("mouseout",C),document.removeEventListener("click",T),document.removeEventListener("keydown",w)}function v(o){if(!h||!d)return;const t=o.target;u=t,d.highlight(t)}function C(o){}function w(o){if(!h||!u||!d)return;let t=null;o.key==="ArrowUp"?t=u.parentElement:o.key==="ArrowDown"?t=u.firstElementChild:o.key==="ArrowLeft"?t=u.previousElementSibling:o.key==="ArrowRight"&&(t=u.nextElementSibling),t&&t!==u&&(o.preventDefault(),u=t,d.highlight(u))}function T(o){var r;if(!h)return;o.preventDefault(),o.stopPropagation();const t=u||o.target,n=b.generate(t);if(m==="pagination"){console.log("Next Button Selected:",t),g({action:"NEXT_BUTTON_SELECTED",payload:{selector:n,innerText:t.innerText}}),N();return}const e=L.findSimilar(t,n),i=e.length;console.log("Selected:",t),console.log(`Found ${i} similar elements`),d&&d.highlightGroup(e),g({action:"ELEMENT_SELECTED",payload:{tagName:t.tagName,className:t.className,innerText:(r=t.innerText)==null?void 0:r.substring(0,50),selector:n,similarCount:i}})}
})()
